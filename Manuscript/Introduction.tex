\section* {Introduction}

\par Multidimensional parallel transmission \cite{Katscher:2003:Magn-Reson-Med:12509830,zhu2004parallel} has been widely investigated for applications including
reduced field-of-view imaging \cite{malik:mrm:2015,mooiweer:2016},
transmit field ($B_1^+$) inhomogeneity compensation \cite{Zhang:2007:Magn-Reson-Med:16526012,cloos:kpstd:2012},
and compensation of susceptibility-induced signal loss \cite{deng:2009}.
One of the first algorithms developed to demonstrate the concept of parallel transmission was formulated in the k-space domain \cite{Katscher:2003:Magn-Reson-Med:12509830}.
In that method, a dense system matrix was constructed by Fourier transforming each transmit coil's $B_1^+$ map,
forming a 2D convolution matrix for each coil, and then concatenating the coils' convolution matrices.
The target pattern was also Fourier transformed and the pulses were solved by regularized pseudoinverse of the system matrix. 
A spatial domain formulation \cite{Grissom:2006:MRM} was proposed soon after,
wherein a non-uniform discrete Fourier transform matrix is constructed, 
duplicated for each transmit coil, and weighted by that coil's $B_1^+$ map.
The weighted matrices are concatenated and the pulses are solved by regularized pseudoinverse of the system matrix
or using an iterative method.
The spatial domain method is mathematically straightforward 
and enables flexible modeling and compensation of effects such as off-resonance, 
incorporation of regions of interest,
and the use of non-uniform fast Fourier transforms to accelerate matrix multiplies.
Since its introduction, nearly all parallel transmission studies have used the spatial domain method. 

\par Despite the spatial domain method's strengths, 
it can have prohibitive computational requirements when the number of coils and the number of dimensions become large, 
for example in three-dimensional and spectral-spatial pulse designs, and when off-resonance compensation is used.  
The computation is multiplied further when the method is applied iteratively in magnitude least-squares \cite{setsompop2008magnitude} or constrained pulse designs \cite{brunner2010optimal,hoyos:tmi:2014}. 
Particularly, current spatial domain design methods map any given RF pulse $\mathbf{b}$ to its spatial excitation pattern $\mathbf{d}$ with a large system matrix $\mathbf{A}$, as:
\begin{equation*}
	\mathbf{d}=\mathbf{Ab}
\end{equation*}
The size of $\mathbf{A}$ is $N_s$ by $N_cN_t$, where $N_s$ is the number of spatial locations, $N_c$ is the number of coils, and $N_t$ is the number of RF samples. 
Since $N_s$ becomes unbearably large in designs such as 2D plus spectral and 3D problems, 
and $N_c$ increases with more advance hardware designs, 
$\mathbf{A}$ is typically too large to store explicitly or directly invert. 
Therefore, such design problems need to be solved by iterative conjugate-gradient (CG) methods which avoid matrix inversion. 
However, even if no matrix inversions are performed, the large system matrix may still be memory-inefficient when used in many matrix multiplications over a large number of iterations, making the solving process very slow. Furthermore, the NUFFT-based pulse design methods can also be slow due to all the gridding steps.
Although these can be eliminated in NUFFT-based image reconstruction using Toeplitz formulation \cite{fessler2005toeplitz}, 
in RF pulse design the Toeplitz formulation does not exist since the inner product is over space. 
These slow design methods are especially undesirable when tailored pulses are needed to be designed for each subject during one's examination in the scanner. Typically, the subject-tailored pulse design has to be done within one minute in the pre-scan stage, so that the incorporation of fast design of subject-tailored pulses into currently used workflow is desirable.  

\par One application of subject-tailored multidimensional pTx pulses that is of particular interest of this paper is the 3D inner volume suppression (IVS) pulses for MR Corticography (MRCoG).MRCoG is a developing imaging technique which aims for submillimeter isotropic resolution whole-cortex and cortex-specific imaging. 
It is a promising technique to enable whole-brain functional and diffusion studies of the columnar and laminar subcortical structures, which are the fundamentals of higher-order brain functions. 
%The current columnar and laminar fMRI methods all use a small field of view in order to achieve sub-millimeter resolution. This does not allow studies to be performed across the whole cerebral cortex. On the other hand, current whole brain fMRI methods typically have spatial resolution greater than 1 mm, which is not sufficient for the studies of columnar and laminar structures. 
MRCoG will use IVS to enable highly accelerated imaging of the cortex, by reducing g-factor and suppressing physiological noise from ventricle CSF. Therefore, subject-tailored IVS pTx pulses are needed, which could be applied before each excitation and readout. Thanks to the high performance gradient system an the 24-channel transmit system of the developing MRCoG scanner, good IVS with 3D selective excitation pulses becomes feasible. However, this IVS pulse design problem is challenging due to its 3D nature and the large number of transmit channels. 

\par Here we propose a k-space-based approach to pTx pulse design that has low memory and computational requirements, and is highly parallelizable. Specifically, we build a sparse system matrix $\mathbf{W}$ that relates the Fourier transform of the spatial domain desired pattern and the desired RF pulse, so that the RF pulse can be instantaneously solved by a sparse matrix multiplication with no matrix inversion or iterative CG method. We advance the work by Katscher et al \cite{katscher2003transmit} by solving the columns of the system matrix in a parallelized fashion. This is done by utilizing the independence between columns of the system matrix which comes from the compactness of sensitivity maps in k-space. 
In the following text, we will derive the independent solution to each column and show a patch-wise parallelization that allows the control of the size and accuracy of each instance problem. We further accelerate the solution of each instance problem by proposing an efficient method to construct a key matrix needed while maintaining accuracy. Off-resonance correction is also incorporated into this k-space domain design. 
Then we apply this k-space domain design method to the 3D IVS pulse design problem, and demonstrate its striking acceleration to the computation speed by comparing its performance to the conventional spatial domain design method through simulations. We show how the computation speed and accuracy can be traded off through controlling the parameters of the patch-wise parallelization. We also demonstrate the k-space domain design's ability to accommodate excitation k-space undersampling and correct off-resonance.  