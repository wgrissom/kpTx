%!TEX root = kPtx_paper.tex
\section*{Results}

\begin{figure}
	\centering
	\includegraphics[width=\textwidth]{ErrorMap}
	\caption{\textcolor{red}{WAG: I think this is the figure that your example in Github should replicate.}
	Normalized excitation patterns (top row) and error maps (bottom row) in central axial, sagittal and coronal slices 
	for k-space domain (left) and spatial domain designs (right).}
	\label{fig:ErrorMap}
\end{figure}
Figure \ref{fig:ErrorMap} shows simulated excitation patterns and error maps for spatial and k-space domain designs. 
The k-space design was performed with 16 parallel threads and patch and inclusion widths of 4. 
Both designs were performed with a 64$\times$64$\times$48 grid size (3 mm isotropic resolution), 
and the excitation patterns were evaluated against the target pattern on a 128$\times$128$\times$96 grid size (1.5 mm iso-resolution). 
The calculated root-mean-squared errors (RMSEs) were 2.42\% (spatial domain) and 2.68\% (k-space domain), 
respectively. 
For both design methods, most of the errors appeared at the edges of the transition band, and errors elsewhere were lower than 5\% of the target flip angle. 
This indicates uniform inner volume excitation while maintaining the outer volume intact. 
The parallelized k-space domain design required 2.9 seconds computation versus 100.9 seconds for the spatial domain method, a 97\% decrease.

\begin{figure}
	\centering
	\includegraphics[width=\textwidth]{ComputationTime}
	\caption{(a) k-Space computation time versus number of parallel threads, for patch and inclusion widths of 4. 
	(b) Computation time (blue axis) and RMSE (red axis) versus patch width, for an inclusion width of 4 and 16 threads. 
	(c) Computation time (blue axis) and RMSE (red axis) versus inclusion width, for patch widths of 4 and 8 and 16 threads.}
	\label{fig:ComputationTime}
\end{figure}
Figure \ref{fig:ComputationTime}a shows the mean computation time versus different thread numbers. The k-space design problem held the patch and inclusion width constant at 4. The mean computation time decreases with increasing thread numbers before 12 threads, and then plateaus due to overhead. The thread number was conservatively chosen to be 16 for the following studies to ensure timely solutions. 
Figure \ref{fig:ComputationTime}b shows the mean computation time and the RMSE with different patch widths. The computation time increases and the RMSE decreases as the patch width increases. This was because when patch width increases, there are more excitation trajectory points included in one instance problem, even with the same inclusion width. As a result, each instance problem becomes bigger and more time consuming, which cancels the advantageous fact that there are fewer instance problems in total, especially in cases with parallel computing. Furthermore, increasing the patch width is equivalently increasing the inclusion widths for the center target points within each patch, which makes the solutions more accurate. Here, we chose patch widths 4 and 8 (labeled $2^2$ and $2^3$) to balance time and accuracy for further evaluation.
Figure \ref{fig:ComputationTime}c shows the mean computation time and the RMSE with different inclusion widths. The solid lines and dashed lines were obtained with patch width 4 and 8, respectively. Computation time increases and error decreases with increasing inclusion width. Particularly, increasing inclusion width is equivalent to utilizing more accurate $B_1^+$ information by truncating the $B_1^+$ map Fourier transforms to zero further out from DC. For both patch widths 4 and 8, 4 is the optimal inclusion width, which confirms the result in \ref{fig:ComputationTime}a , previously. Using an inclusion width of 4, the computation time and error are acceptable for both patch width numbers. Following these results,  we chose patch width 4 for the further designs.

\begin{figure}
	\centering
	\includegraphics[width=\textwidth]{L_curve}
	\caption{L-curves for spatial domain and k-space domain pulse designs, 
	repeated across five orders of magnitude of the methods' Tikhonov regularization parameters.
	The k-space domain designs were repeated using patch and inclusion widths of four versus solving for the entire domain at once (`Path / Inclusion Width = 4' versus `Full Patch'),
	and using $B_1^+$ map product interpolation versus phase modulation to each trajectory location (`Interpolated $\bm{S}^H\bm{S}$ Matrices' versus
	`Exact $\bm{S}^H\bm{S}$ Matrices').}
	\label{fig:LCurves}
\end{figure}



\begin{figure}
	\centering
	\includegraphics[width=\textwidth]{GibbsRinging}
	\caption{Normalized error maps and RMSE for \textbf{(a)} spatial domain design and \textbf{(c)} k-space domain design with 6 mm iso-resolution, 32$\times$32$\times$24 design grid. Red arrows indicate the Gibbs ringing in low-resolution spatial domain design. \textbf{(b)} Normalized error map for spatial domain design with 3 mm iso-resolution, 64$\times$64$\times$48 design grid.}
	\label{fig:GibbsRing}
\end{figure}

Figure \ref{fig:GibbsRing}a\&c show the results of the  low-resolution designs using k-space domain method and the spatial domain method. The result of the high-resolution design of the spatial domain is also shown in Figure \ref{fig:GibbsRing}b. All three designed were done with a excitation trajectory that matches the 6 mm iso-resolution. The red arrows indicate the Gibbs ringing in the low-resolution spatial domain design, that can only be suppressed with high-resolution spatial domain design. However, the k-space domain design, although also low-resolution, is insensitive to this problem. Furthermore, the ripple pattern in the low resolution k-space design matches the high-resolution spatial design. Looking from a spatial domain point of view, the Gibbs ringing was caused by the lack of ability to observe the ringing with low-resolution. Looking from a k-space domain point of view, the Gibbs ringing was due to "wrap back" of the k-space FOV. When the spatial resolution is low the k-space FOV is small, and therefore the RF samples at one end of the trajectory can incorrectly "reach" and affect the k-space points at the other end of the k-space FOV in a circulation shift fashion. However, for the k-space domain design, even with low resolution, there is no k-space "wrap back" because the incorporated trajectory points are explicitly specified. Particularly, for the instance problems whose patches are at the edges of the k-space FOV, the excitation trajectory points at the other ends of the k-space FOV will not be incorporated into the design.    


\begin{figure}
	\centering
	\includegraphics[width=\textwidth]{ReductionFactor}
	\caption{Normalized error maps and RMSE for spatial domain design (first row) and k-space domain design (second row), 
	using excitation k-space trajectories with different reduction factors (third row).
	The reduction factors are referenced to the 10 ms trajectory in Figure \ref{fig:Target} (second column).}
	\label{fig:kspace_PTX_Acceleration}
\end{figure}

Figure \ref{fig:kspace_PTX_Acceleration} shows a comparison between the performance of spatial domain design (first row) and k-space domain design (second row) regarding undersampled excitation trajectories (third row) with different reduction factors. Both design methods had larger errors when the excitation k-space was less densely traversed. The k-space domain design provided similar error maps and practically equal RMSE. The k-space domain design had slightly larger RMSE because of the interpolation and truncation of the k-space sensitivity when building the $\mathbf{S}^{H}\mathbf{S}$ matrix, and can be improved by increasing the inclusion width. 


\begin{figure}
	\centering
	\includegraphics[width=\textwidth]{OffResonance}
	\caption{\textcolor{red}{WAG: Update with new correction method; include compute times and errors versus number of segments}
	\textbf{(a)} Normalized off-resonance map with Gaussian distortion centered above the frontal sinus, mimicking a characteristic susceptibility induced $B_0$ inhomogeneity. \textbf{(b)} Normalized excitation maps and RMSE for spatial domain design with off-resonance correction (first row), k-space domain design with and without off-resonance correction (second \& third rows).}
	\label{fig:kspace_PTX_B0}
\end{figure}

Regarding 3D off-resonance patterns with the shape shown in Figure \ref{fig:kspace_PTX_B0}a and different scaling, Figure \ref{fig:kspace_PTX_B0}b shows the excitation maps of three types of designs: spatial domain design with off-resonance correction (first row), k-space domain design with and without off-resonance correction (second \& third row). As shown in the second row of Figure \ref{fig:kspace_PTX_B0}b, off-resonance caused false excitation outside the designated suppression region, and must be corrected. With 200 Hz maximum off-resonance, which is the typical range of off-resonance observed in clinical studies, k-space domain design with correction was able to fully correct the off-resonance artifacts. It was also able to provide excitation pattern comparable to spatial domain design with 400 Hz maximum off-resonance. The k-space domain design has a weaker performance with higher off-resonance due to the fact that the time segmentation approximation in Ref \cite{fessler2005toeplitz} was meant to approximate forward models from RF to excitation patterns and does not serve as an accurate approximation to the backward model as we need in the k-space domain design.